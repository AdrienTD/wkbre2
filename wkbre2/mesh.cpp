// wkbre2 - WK Engine Reimplementation
// (C) 2021 AdrienTD
// Licensed under the GNU General Public License 3

#include "mesh.h"
#include "file.h"
#include <cassert>
#include "util/BinaryReader.h"

const std::array<Vector3, 256> Mesh::s_normalTable = {
Vector3{0.808092f, 0.444655f, -0.386355f}, {-0.456426f, -0.729133f, 0.509942f}, {-0.600703f, -0.527135f, -0.601069f}, {-0.898221f, -0.203762f, -0.389462f}, {0.243796f, -0.096599f, 0.965004f}, {0.608059f, 0.752839f, -0.251987f}, {-0.421935f, 0.886955f, -0.187833f}, {0.910585f, 0.268347f, 0.314364f}, {-0.673626f, -0.723759f, 0.149674f}, {0.625561f, 0.209396f, -0.751550f}, {-0.696196f, 0.269262f, -0.665439f}, {-0.184171f, -0.982517f, -0.027217f}, {0.343731f, -0.067672f, -0.936627f}, {-0.602991f, 0.737327f, -0.304552f}, {-0.587473f, 0.510824f, -0.627642f}, {-0.647096f, -0.554946f, 0.522784f},
{-0.354654f, -0.257923f, -0.898719f}, {0.274678f, 0.801876f, -0.530610f}, {-0.781383f, -0.376611f, -0.497599f}, {0.317486f, 0.646651f, -0.693574f}, {0.055929f, 0.990906f, -0.122380f}, {0.345819f, -0.737888f, 0.579594f}, {-0.451111f, -0.887842f, -0.090751f}, {-0.912034f, 0.211783f, -0.351201f}, {-0.620471f, -0.347854f, 0.702861f}, {-0.596301f, 0.579799f, 0.555210f}, {-0.641796f, 0.685285f, 0.344212f}, {0.428539f, -0.656028f, -0.621275f}, {0.363572f, -0.323209f, 0.873700f}, {0.264355f, -0.282562f, -0.922104f}, {0.787559f, 0.011651f, -0.616129f}, {0.844233f, 0.182530f, 0.503938f},
{-0.969711f, 0.243394f, 0.020489f}, {-0.624959f, 0.363099f, 0.691075f}, {0.992850f, -0.118391f, 0.015265f}, {-0.335802f, 0.736196f, -0.587582f}, {0.227509f, -0.683621f, -0.693471f}, {0.040555f, -0.645209f, 0.762929f}, {-0.692354f, 0.103003f, 0.714168f}, {-0.780787f, 0.560530f, -0.276004f}, {-0.661048f, 0.094352f, -0.744387f}, {-0.372030f, -0.673144f, -0.639117f}, {0.013698f, 0.494687f, -0.868963f}, {0.546409f, -0.638330f, 0.542192f}, {-0.201223f, 0.574127f, 0.793655f}, {-0.547434f, 0.836684f, -0.016601f}, {-0.868532f, 0.081126f, 0.488948f}, {0.300499f, -0.473701f, -0.827833f},
{-0.786697f, 0.602525f, 0.134431f}, {-0.054725f, 0.273011f, -0.960453f}, {0.570862f, -0.031635f, -0.820436f}, {0.738818f, -0.585357f, -0.333924f}, {0.945515f, -0.267979f, 0.184903f}, {-0.927834f, -0.368990f, -0.054505f}, {-0.461693f, -0.542551f, 0.701768f}, {0.454071f, 0.392386f, 0.799908f}, {-0.416641f, 0.905267f, 0.083083f}, {0.504375f, 0.807268f, 0.306470f}, {-0.203602f, -0.553856f, 0.807335f}, {0.679141f, 0.413146f, -0.606694f}, {0.485646f, 0.440706f, -0.754935f}, {0.673468f, -0.720994f, -0.163123f}, {0.886304f, -0.461019f, 0.043884f}, {0.104072f, -0.815899f, 0.568752f},
{-0.738915f, -0.141810f, 0.658707f}, {-0.691632f, -0.715600f, -0.097782f}, {-0.441185f, 0.771982f, 0.457602f}, {0.441951f, -0.870455f, 0.216764f}, {-0.640856f, 0.759761f, 0.109846f}, {0.947975f, 0.317187f, 0.027132f}, {-0.808657f, -0.585839f, 0.053544f}, {0.081409f, 0.868901f, 0.488246f}, {-0.411668f, 0.449848f, -0.792569f}, {0.086523f, -0.123656f, -0.988546f}, {-0.444450f, 0.823739f, -0.352021f}, {-0.735922f, -0.564408f, -0.373982f}, {-0.792320f, -0.076378f, -0.605307f}, {-0.069488f, 0.765591f, 0.639564f}, {-0.308008f, 0.912053f, 0.270724f}, {0.387621f, 0.155368f, 0.908631f},
{0.424741f, 0.902984f, 0.064917f}, {0.042874f, 0.915413f, -0.400227f}, {0.636084f, -0.386358f, -0.667926f}, {-0.308196f, -0.160207f, 0.937736f}, {-0.565209f, -0.668202f, -0.483781f}, {-0.180208f, -0.605016f, -0.775552f}, {-0.881837f, -0.373109f, -0.288363f}, {-0.389257f, -0.488844f, -0.780712f}, {0.809370f, 0.549431f, -0.207476f}, {-0.999680f, 0.015266f, 0.020168f}, {0.399733f, 0.209016f, -0.892483f}, {0.899296f, 0.132047f, -0.416931f}, {-0.286871f, 0.685846f, 0.668819f}, {-0.245328f, -0.896727f, 0.368367f}, {-0.098337f, 0.705913f, -0.701439f}, {0.694000f, 0.352968f, 0.627517f},
{-0.461285f, 0.227670f, -0.857544f}, {-0.758681f, 0.643233f, -0.103219f}, {-0.834269f, -0.526813f, -0.162674f}, {0.718549f, -0.562647f, 0.408799f}, {-0.821934f, 0.165341f, -0.545057f}, {-0.423710f, 0.477169f, 0.769922f}, {-0.236313f, 0.343992f, -0.908750f}, {-0.195587f, -0.795425f, -0.573624f}, {-0.603167f, -0.147616f, -0.783837f}, {0.833170f, -0.516343f, -0.198034f}, {0.649966f, 0.603441f, -0.461956f}, {-0.562514f, -0.138747f, 0.815063f}, {0.600099f, -0.741469f, 0.300175f}, {-0.969717f, -0.199623f, -0.140710f}, {-0.158053f, -0.830590f, 0.533985f}, {-0.287408f, -0.671873f, 0.682630f},
{-0.172117f, 0.523199f, -0.834649f}, {0.799135f, -0.215860f, -0.561060f}, {0.878999f, -0.327944f, -0.346140f}, {0.049084f, -0.543296f, -0.838105f}, {0.024893f, -0.936850f, 0.348845f}, {0.630469f, 0.622958f, 0.463069f}, {0.081136f, -0.994592f, 0.064839f}, {-0.527722f, -0.354519f, -0.771897f}, {-0.539652f, -0.794932f, -0.277233f}, {0.673748f, -0.129787f, 0.727475f}, {-0.132092f, 0.909540f, 0.394067f}, {-0.330035f, 0.161145f, 0.930112f}, {-0.890556f, -0.128632f, 0.436308f}, {0.015770f, 0.661932f, 0.749398f}, {-0.038407f, 0.971738f, 0.232917f}, {-0.242240f, 0.968054f, -0.064735f},
{-0.974538f, -0.006960f, -0.224114f}, {0.484612f, -0.286142f, -0.826604f}, {0.490734f, -0.460765f, -0.739511f}, {0.563716f, 0.824340f, -0.051845f}, {-0.351184f, -0.833821f, -0.425926f}, {0.450206f, -0.539459f, 0.711546f}, {-0.279406f, -0.930567f, -0.236597f}, {0.202571f, 0.737635f, 0.644096f}, {-0.895900f, 0.434866f, -0.090856f}, {-0.333947f, -0.935654f, 0.114149f}, {-0.470405f, -0.830342f, 0.298748f}, {-0.404353f, -0.385236f, 0.829513f}, {0.682490f, -0.379429f, 0.624693f}, {-0.135019f, -0.976950f, 0.165344f}, {0.979605f, 0.071204f, -0.187893f}, {0.830159f, -0.313955f, 0.460727f},
{-0.151092f, -0.435964f, -0.887191f}, {-0.019763f, 0.178444f, 0.983752f}, {0.157083f, 0.107041f, -0.981767f}, {0.738362f, -0.656336f, 0.155065f}, {-0.757158f, 0.364606f, 0.542009f}, {0.952384f, -0.178236f, -0.247380f}, {0.287041f, 0.467366f, -0.836168f}, {0.419787f, -0.811948f, 0.405611f}, {0.898981f, -0.060293f, -0.433817f}, {-0.007519f, -0.712811f, -0.701316f}, {0.455687f, -0.101982f, 0.884279f}, {-0.076145f, -0.246821f, -0.966065f}, {0.588239f, -0.806938f, 0.053158f}, {0.071673f, -0.845833f, -0.528610f}, {-0.446631f, -0.002592f, -0.894714f}, {0.108493f, -0.284943f, 0.952385f},
{0.261393f, 0.918640f, -0.296266f}, {-0.189784f, -0.070330f, -0.979304f}, {0.805214f, 0.209550f, -0.554725f}, {0.940139f, -0.331645f, -0.078429f}, {-0.875143f, 0.349788f, 0.334324f}, {-0.249029f, 0.160225f, -0.955150f}, {0.165088f, 0.981329f, 0.098686f}, {0.942236f, 0.087354f, 0.323359f}, {0.521263f, -0.781007f, -0.343967f}, {0.851518f, 0.523399f, 0.031157f}, {-0.144472f, -0.329223f, 0.933135f}, {0.319886f, -0.834856f, -0.447982f}, {-0.181725f, 0.838811f, -0.513198f}, {0.922799f, 0.331337f, -0.196618f}, {-0.903520f, 0.025291f, -0.427799f}, {-0.470497f, 0.273433f, 0.838968f},
{0.191713f, -0.533305f, 0.823912f}, {0.175347f, 0.331251f, -0.927106f}, {0.067668f, -0.394194f, -0.916533f}, {-0.970735f, 0.186269f, -0.151581f}, {0.047399f, -0.440209f, 0.896643f}, {-0.042103f, 0.069657f, -0.996682f}, {0.848974f, 0.469431f, 0.242645f}, {0.725640f, 0.136628f, 0.674374f}, {0.459494f, 0.702795f, 0.543088f}, {-0.771823f, -0.556260f, 0.307999f}, {-0.793686f, 0.371934f, -0.481380f}, {0.255866f, -0.925992f, 0.277619f}, {-0.892083f, 0.423660f, 0.157165f}, {-0.965763f, -0.210795f, 0.151219f}, {-0.196676f, 0.930433f, -0.309215f}, {-0.556744f, 0.335791f, -0.759790f},
{-0.236658f, 0.338326f, 0.910785f}, {0.795864f, -0.095783f, 0.597851f}, {0.349423f, -0.935995f, 0.042628f}, {0.703558f, 0.661548f, 0.259539f}, {-0.883665f, -0.435100f, 0.172695f}, {-0.024928f, -0.988799f, -0.147159f}, {-0.153379f, 0.983738f, 0.093456f}, {0.478172f, 0.618047f, -0.623995f}, {-0.704287f, -0.305509f, -0.640815f}, {-0.753973f, -0.360344f, 0.549251f}, {0.773952f, 0.439592f, 0.455804f}, {0.432864f, 0.787534f, -0.438656f}, {-0.973200f, -0.005774f, 0.229889f}, {0.070277f, 0.817631f, -0.571437f}, {0.655257f, -0.228501f, -0.720018f}, {0.587018f, 0.501629f, 0.635435f},
{0.565664f, 0.268641f, 0.779651f}, {0.791825f, -0.608283f, -0.054825f}, {0.239913f, 0.931732f, 0.272613f}, {0.119877f, 0.648519f, -0.751700f}, {0.233140f, -0.855030f, 0.463216f}, {0.447147f, 0.877217f, -0.174783f}, {-0.095030f, -0.924959f, -0.367994f}, {0.024404f, 0.444556f, 0.895419f}, {0.416874f, -0.890209f, -0.183698f}, {0.197727f, -0.928956f, -0.312962f}, {0.621295f, 0.043942f, 0.782344f}, {0.219016f, -0.694018f, 0.685836f}, {-0.536531f, -0.838573f, 0.094495f}, {0.217455f, -0.968593f, -0.120589f}, {0.989822f, 0.105536f, 0.095467f}, {0.234608f, 0.555054f, 0.798044f},
{0.604123f, -0.611391f, -0.511113f}, {0.203710f, 0.307910f, 0.929351f}, {-0.625561f, -0.701734f, 0.340943f}, {-0.768539f, 0.522992f, 0.368548f}, {-0.028858f, -0.113245f, 0.993148f}, {-0.959738f, 0.171029f, 0.222827f}, {-0.841200f, -0.389882f, 0.374666f}, {0.318881f, 0.839267f, 0.440392f}, {-0.488911f, 0.834567f, 0.253897f}, {0.409386f, 0.580371f, 0.703969f}, {-0.245623f, 0.814703f, 0.525289f}, {0.920400f, -0.176771f, 0.348735f}, {0.320419f, 0.945050f, -0.064898f}, {-0.882297f, 0.368563f, -0.292767f}, {-0.479609f, 0.722761f, -0.497587f}, {0.844571f, -0.479234f, 0.238820f},
{0.740620f, 0.671214f, 0.030870f}, {-0.675182f, 0.593496f, -0.438055f}, {-0.352247f, 0.617404f, -0.703373f}, {0.558015f, -0.296253f, 0.775148f}, {-0.178627f, 0.016406f, 0.983780f}, {0.603347f, 0.784862f, 0.141294f}, {0.133218f, 0.088095f, 0.987164f}, {0.777528f, -0.403521f, -0.482308f}, {0.976820f, -0.064991f, 0.203957f}, {-0.462412f, 0.590766f, 0.661189f}, {-0.563169f, 0.112945f, 0.818587f}, {-0.425479f, 0.015978f, 0.904827f}, {0.449499f, 0.049594f, -0.891903f}, {-0.112093f, -0.707121f, 0.698151f}, {-0.676042f, -0.687868f, -0.264207f}, {0.111249f, -0.080442f, 0.990532f},
};

void Mesh::load(const char * filename)
{
	char *fcnt; int fsize;
	LoadFile(filename, &fcnt, &fsize);
	BinaryReader br(fcnt);
	std::string sign = br.readString(4);
	if (sign != "Mesh")
		return;
	uint32_t version = br.readUint32();
	uint32_t flags = br.readUint32();

	// Attachment points
	numAttachPoints = br.readUint16();
	attachPoints.resize(numAttachPoints);
	for (uint16_t i = 0; i < numAttachPoints; i++) {
		AttachmentPoint &ap = attachPoints[i];
		ap.tag = br.readStringZ();
		ap.staticState.position.x = br.readFloat();
		ap.staticState.position.y = br.readFloat();
		ap.staticState.position.z = br.readFloat();
		ap.staticState.orientation[0] = br.readFloat();
		ap.staticState.orientation[1] = br.readFloat();
		ap.staticState.orientation[2] = br.readFloat();
		ap.staticState.orientation[3] = br.readFloat();
		ap.staticState.on = br.readUint8();
		ap.path = br.readStringZ();
	}

	// Vertex positions
	numVertices = br.readUint16();
	vertices.resize(3*numVertices);
	for (uint16_t i = 0; i < 3*numVertices; i++)
		vertices[i] = br.readFloat();

	// Sphere
	this->sphereCenter = br.readVector3();
	this->sphereRadius = br.readFloat();

	// Vertex remapper
	if (version < 4) {
		uint16_t nremap = br.readUint16();
		assert(nremap == numVertices);
		this->vertexRemapper.resize(nremap);
		for (int i = 0; i < nremap; i++)
			this->vertexRemapper[i] = br.readUint16();
	}
	else {
		this->vertexRemapper.resize(numVertices);
		for (int i = 0; i < numVertices; i++)
			this->vertexRemapper[i] = i;
	}

	// Normals
	numNormals = br.readUint16();
	uint32_t numElem = br.readUint32();
	br.seek(numElem * 2);

	// Materials
	uint32_t nmat = br.readUint16();
	this->materials.resize(nmat);
	for (uint32_t i = 0; i < nmat; i++)
	{
		Material &mat = this->materials[i];
		mat.alphaTest = br.readUint8();
		mat.textureFilename = br.readStringZ();
	}

	// Texture coordinates
	uint32_t nuvlist = br.readUint32();
	this->uvLists.resize(nuvlist);
	for (auto &uvlist : this->uvLists)
	{
		uint16_t ntexc = br.readUint16();
		uvlist.resize(2*ntexc);
		for (int u = 0; u < 2*ntexc; u++)
			uvlist[u] = br.readFloat();

	}

	// Groups
	uint32_t ngrp = br.readUint32();
	groupIndices.resize(ngrp);
	for (DynArray<IndexTuple> &group : groupIndices) {
		uint16_t ntup = br.readUint16();
		group.resize(ntup);
		for (IndexTuple &t : group) {
			t.vertex = br.readUint16();
			t.normal = br.readUint16();
			t.uv = br.readUint16();
		}
	}

	// Polygon List
	uint32_t npolylists = br.readUint32();
	polyLists.resize(npolylists);
	for (PolygonList &polylist : polyLists) {
		polylist.numVerts = br.readUint16();
		polylist.numNorms = br.readUint16();
		polylist.numUvs = br.readUint16();
		polylist.distance = br.readFloat();
		polylist.groups.resize(ngrp);
		int matcount = 0;
		for (PolyListGroup &grp : polylist.groups) {
			uint16_t group_size = br.readUint16();
			uint16_t vertex_list_length = br.readUint16();
			uint16_t material_index = br.readUint16();
			//assert(vertex_list_length == group_size * 3);
			assert(material_index == matcount++);
			grp.tupleIndex.resize(group_size);
			for (std::array<uint16_t, 3> &t : grp.tupleIndex) {
				for (int i = 0; i < 3; i++)
					t[i] = br.readUint16();
			}
		}
	}

	// Normals
	normals.resize(numNormals);
	for (uint8_t& n : normals)
		n = br.readUint8();

	// Normal remapper
	if (version < 4) {
		uint16_t nremap = br.readUint16();
		assert(nremap == numNormals);
		normalRemapper.resize(nremap);
		for (int i = 0; i < nremap; i++)
			normalRemapper[i] = br.readUint16();
	}
	else {
		normalRemapper.resize(numNormals);
		for (int i = 0; i < numNormals; i++)
			normalRemapper[i] = i;
	}
}

const Vector3* Mesh::decodeNormals()
{
	static std::vector<Vector3> decodedNorms;
	static Mesh* prevcall = nullptr;
	if (this == prevcall)
		return decodedNorms.data();
	prevcall = this;

	decodedNorms.resize(normals.size());
	for (size_t i = 0; i < normals.size(); i++)
		decodedNorms[i] = s_normalTable[normals[i]];
	return decodedNorms.data();
}
